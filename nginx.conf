events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen 80;
        server_name localhost;

        # 处理注册页面的路由
        location = /register {
            # 这里的路径对应 docker-compose.yml 挂载进去的路径
            alias /var/www/html/register.html;
            default_type text/html;
        }

        location /api/register-user {
            # n8n 的 Webhook 地址
            proxy_pass https://n8n.taoziyoyo.com/webhook/register;
            
            # 1. 设置 Host 头，告诉后端应用我们访问的是谁
            proxy_set_header Host n8n.taoziyoyo.com;
            
            # 2. [关键修复] 开启 SNI。这告诉 Cloudflare 我们要连接 n8n 这个域名
            # 没有这一行，Cloudflare 握手会失败导致 502
            proxy_ssl_server_name on;
            
            # 3. [关键修复] 关闭 SSL 验证。
            # 容器内的根证书可能不全，或者 Cloudflare 边缘证书有些特殊，关闭验证能确连通性
            proxy_ssl_verify off;
            
            # 传递真实 IP
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # 关闭缓存
            proxy_buffering off;
        }
        
        # 核心：反代 PhotoPrism
        location / {
            # 指向 docker-compose 网络内部的 photoprism 服务名
            proxy_pass http://photoprism:2342;

            # [重要] 强制后端不压缩，否则 sub_filter 无法修改内容
            proxy_set_header Accept-Encoding "";

            # 传递真实 IP
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 支持 WebSocket (PhotoPrism 需要)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # --- 注入逻辑开始 ---
            # 在 </body> 前插入 HTML 代码
            sub_filter_types text/html;
            sub_filter_once on;
            sub_filter '</body>' '
            <div id="custom-inject-btn" style="display:none; position:fixed; bottom:40px; right:40px; z-index:99999;">
                <a href="/register" target="_self" style="
                    display: flex; align-items: center; gap: 8px;
                    padding: 12px 24px;
                    background: linear-gradient(135deg, #d67b93 0%, #c45a75 100%);
                    color: white;
                    text-decoration: none;
                    border-radius: 50px;
                    font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
                    font-weight: 600;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    transition: all 0.3s ease;
                    border: 1px solid rgba(255,255,255,0.1);
                " onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 6px 20px rgba(214,123,147,0.4)\'" 
                   onmouseout="this.style.transform=\'translateY(0)\';this.style.boxShadow=\'0 4px 15px rgba(0,0,0,0.3)\'">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                    <span>Create Account</span>
                </a>
            </div>

            <script>
            (function() {
                var btn = document.getElementById("custom-inject-btn");
                function checkUrl() {
                    // PhotoPrism 的登录页通常包含 /login 或者页面上有特定的登录表单
                    // 这里判断 URL 是否包含 login，或者 DOM 中是否存在登录特定元素
                    if (window.location.href.indexOf("/login") !== -1 || document.querySelector(".auth-form")) {
                        btn.style.display = "block";
                    } else {
                        btn.style.display = "none";
                    }
                }
                // 监听 URL 变化 (SPA)
                window.addEventListener("popstate", checkUrl);
                // 简单的轮询以兼容 pushState 导致的 URL 变化
                setInterval(checkUrl, 500);
            })();
            </script>
            </body>';
            # --- 注入逻辑结束 ---
        }
    }
}
